---
title: Http笔记(三)
date: 2023-03-05T17:39:14Z
tags: ['Http']
draft: false
summary: '记录下http的笔记'
authors: ['default']
---

## HTTP 代理

![](/blog/http代理.png)

`代理服务`:服务本身不生产内容,而是处于中间位置转发上下游的请求和响应,具有双重身份:面向下游的用户时,表现为服务器,代表源服务器响应客户端的请求；而面向上游的源服务器时,又表现为客户端,代表客户端发送请求

### 代理的作用

计算机科学领域里的任何问题,都可以通过引入一个中间层来解决;如果一个中间层解决不了问题,那就再加一个中间层(doge)

代理最基本的一个功能就是`负载均衡`:因为在面向客户端时屏蔽了源服务器,客户端看到的只是代理服务器,源服务器究竟有多少台、是哪些 IP 地址都不知道。于是代理服务器就可以掌握请求分发的“大权”,决定由后面的哪台服务器来响应请求

- 常用的负载均衡算法:

  - `轮询`
  - `一致性哈希`
  - 目的都是尽量把外部的流量合理地分散到多台源服务器,提高系统的整体资源利用率和性能

- 在负载均衡的同时,代理服务还可以执行更多的功能:
  - `健康检查`:使用“心跳”等机制监控后端服务器,发现有故障就及时“踢出”集群,保证服务高可用
  - `安全防护`:保护被代理的后端服务器,限制 IP 地址或流量,抵御网络攻击和过载
  - `加密卸载`:对外网使用 SSL/TLS 加密通信认证,而在安全的内网不加密,消除加解密成本
  - `数据过滤`:拦截上下行的数据,任意指定策略修改请求或者响应
  - `内容缓存`:暂存、复用服务器响应

### 代理相关字段

代理服务器需要用字段`Via`表明代理的身份,该字段`请求头`或`响应头`都可以出现

### 代理协议

- `代理协议`:
  - 由知名的代理软件 `HAProxy` 所定义,也是一个“事实标准”
  - 有 v1 和 v2 两个版本,v1 和 HTTP 差不多,也是明文,而 v2 是二进制格式。今天只介绍比较好理解的 v1,它在 HTTP 报文前增加了一行 ASCII 码文本,相当于又多了一个头

### 总结

- HTTP 代理就是客户端和服务器通信链路中的一个中间环节,为两端提供`代理服务`
- 代理处于`中间层`,为 HTTP 处理增加了更多的灵活性,可以实现负载均衡、安全防护、数据过滤等功能
- 代理服务器需要使用字段`Via`标记自己的身份,多个代理会形成一个列表
- 如果想要知道客户端的真实 IP 地址,可以使用字段`X-Forwarded-For`和`X-Real-IP`
- 专门的`代理协议`可以在不改动原始报文的情况下传递客户端的真实 IP

## 缓存代理

客户端上的缓存控制:能够减少响应时间、节约带宽,提升客户端的客户体验

HTTP 的服务器缓存功能主要由代理服务器来实现(即`缓存代理`)

### 缓存代理服务

代理服务收到源服务器发来的响应数据后需要做两件事.第一个当然是把报文转发给客户端,而第二个就是把报文存入自己的 Cache 里

下一次再有相同的请求,代理服务器就可以直接发送 304 或者缓存数据,不必再从源服务器那里获取.这样就降低了客户端的等待时间,同时节约了源服务器的网络带宽

### 源服务器的缓存控制

要区分客户端上的缓存和代理上的缓存,可以使用两个新属性`private`和`public`

`private`表示缓存只能在客户端保存,是用户“私有”的,不能放在代理上与别人共享.而`public`的意思就是缓存完全开放,谁都可以存,谁都可以用

### 客户端的缓存控制

### 小结

- 计算机领域里最常用的性能优化手段是`时空转换`,也就是`时间换空间`或者`空间换时间`,HTTP 缓存属于后者
- 缓存代理是增加了缓存功能的代理服务,缓存源服务器的数据,分发给下游的客户端
- `Cache-Control`字段也可以控制缓存代理,常用的有` private``s-maxage``no-transform `等,同样必须配合` Last-modified``ETag `等字段才能使用
- 缓存代理有时候也会带来负面影响,缓存不良数据,需要及时刷新或删除
